<!DOCTYPE html>
<html>
    <head>
        <% include ../partials/header.ejs %>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script type="text/javascript" language="javascript">
            $(document).ready(() =>
            {
                const oauthHash = location.hash.substr(1);
                const accessToken = decodeURIComponent(oauthHash.substr(oauthHash.indexOf('access_token=')).split('&')[0].split('=')[1]);
                const stateString = decodeURIComponent(oauthHash.substr(oauthHash.indexOf('state=')).split('&')[0].split('=')[1]);

                if (!accessToken || !stateString)
                    return;

                let state;
                try
                {
                    state = JSON.parse(stateString);
                }
                catch (e)
                {
                    return;
                }

                if (!state.channel)
                    return;

                $("#startAuth").hide();

                $("#loadingChannelText").text("Getting user ID for " + state.channel);
                $("#commandLoading").show();

                $.ajax(
                {
                    url: "https://api.twitch.tv/helix/users",
                    data:
                    {
                        login: state.channel
                    },
                    headers:
                    {
                        "Authorization": "Bearer " + accessToken
                    }
                }).done(data =>
                {
                    $("#commandLoading").hide();

                    if (data.error)
                    {
                        $("#commandFailureText").text(`Error: ${data.error}: ${data.message || "No message"}`);
                        $("#commandFailure").show();
                    }
                    else if (data.data)
                    {
                        if (!data.data[0])
                        {
                            $("#commandFailureText").text("Error: got data but no data[0]");
                            console.log(data);
                            $("#commandFailure").show();
                            return;
                        }

                        if (data.data[0].id)
                        {
                            $("#commandText").val(`!commands add !clip $(urlfetch https://nightbot-clip-command.herokuapp.com/clip?user_access_token=${encodeURIComponent(accessToken)}&channel_id=${encodeURIComponent((data.data[0].id))})`);
                            $("#showCommand").show();
                        }
                        else
                        {
                            $("#commandFailureText").text("Error: got data but no id");
                            $("#commandFailure").show();
                        }
                    }
                    else
                    {
                        $("#commandFailureText").text("Error: no error message or data");
                        $("#commandFailure").show();
                    }
                });
            });
        </script>
    </head>

    <body>
        <div id="startAuth">
            <div>
                <label for="channelToClip">Channel to clip:</label>
                <input type="text" id="channelToClip" onkeypress="textBoxKeyPressed(event)">
            </div>

            <br>

            <div>
                <button type="button" onclick="startAuth()">Login with Twitch</button>
            </div>

            <script type="text/javascript" language="javascript">
                function startAuth()
                {
                    if (!channelToClip.value)
                    {
                        alert("Enter a channel name");
                        return;
                    }

                    window.location.href = "<%= base_url %>" +
                        "?client_id=" + encodeURIComponent("<%= client_id %>") +
                        "&redirect_uri=" + encodeURIComponent("<%= redirect_uri %>") +
                        "&response_type=" + encodeURIComponent("<%= response_type %>") +
                        "&scope=" + encodeURIComponent("<%= scope %>") +
                        "&force_verify=" + encodeURIComponent("<%= force_verify %>") +
                        "&state=" + encodeURIComponent(JSON.stringify(
                        {
                            channel: channelToClip.value
                        }));
                }
                
                function textBoxKeyPressed(event)
                {
                    if (event.keyCode === 13)
                    {
                        event.preventDefault();
                        startAuth();
                    }
                }
            </script>
        </div>

        <div id="commandLoading" style="display:none;">
            <p id="loadingChannelText"></p>
        </div>

        <div id="showCommand" style="display:none;">
            <label for="commandText">Nightbot command:</label>
            <textarea id="commandText" rows="4" cols="80" onClick="this.select();" readonly="readonly"></textarea>
        </div>

        <div id="commandFailure" style="display:none;">
            <p id="commandFailureText"></p>
        </div>
    </body>
</html>